---
title: "Une approche géographique des taux de complétion en France"
author: "Naïma Beck"
output: html_notebook
---

```{r}
library(ggplot2)
library(dplyr)
library(stringr)
```

# Jeu de donnée **'cpf'**
```{r}
cpf <- read.csv("../data/raw/moncompteformation_formations_engagees.csv",sep = ";")
head(cpf)
```

## Noms des colonnes du jeu de donnée **'cpf'** 
```{r}
colnames(cpf)
```

## Ocurrences de la colonne **'statut_dossier'** 
```{r}
unique(cpf$statut_dossier)
```


## Ajout d'une colonne **'statut_dossier_modif'** avec une catégorisation du statut du dossier
```{r}
cpf <- cpf %>%
  mutate(statut_dossier_modif = case_when(
    statut_dossier == "Entrée en formation" ~ "Réalisation partielle",
    statut_dossier == "Sortie de formation" ~ "Réalisation partielle",
    statut_dossier == "Validé" ~ "Réalisation totale",
    statut_dossier == "Clos - Non Réalisé annulé OF" ~ "Annulation titulaire",
    statut_dossier == "Clos - Non Réalisé annulé titulaire" ~ "Annulation titulaire",
    statut_dossier == "Clos - Réalisation Partielle" ~ "Réalisation partielle",
    statut_dossier == "Clos - Réalisation Totale" ~ "Réalisation totale",
    statut_dossier == "Dossier annulé gestionnaire" ~ "Annulation titulaire",
    statut_dossier == "Rejeté" ~ "Annulation titulaire",
    TRUE ~ NA_character_  
  ))

rownames(cpf) <- NULL

head(cpf)
```

## Visualisation de la proportion de personnes ayant terminé la formation par département
```{r}
proportion_formation_terminee <- cpf %>%
  group_by(departement_lieu_formation) %>%
  summarise(
    proportion_terminee = mean(statut_dossier_modif == "Réalisation totale", na.rm = TRUE)  
  )

rownames(cpf) <- NULL

head(proportion_formation_terminee)
```

## graphique à barres avec une taille de texte réduite et les étiquettes des départements pivotées
```{r}
ggplot(proportion_formation_terminee, aes(x = reorder(departement_lieu_formation, proportion_terminee), y = proportion_terminee * 100)) +
  geom_bar(stat = "identity", fill = "steelblue") + 
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +  # Formatter les valeurs en pourcentage
  labs(
    title = "Proportion de personnes ayant terminé la formation par département",
    x = "Département",
    y = "Proportion ayant terminé la formation (%)"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, hjust = 1, size = 6),  # Rotation des étiquettes pour lisibilité
    axis.text.y = element_text(size = 8)  # Réduire la taille des labels des pourcentages
  )
```

# Travaillons sur un jeu de donnée réel

## Question 1

Recherche de doublons : il n'y en a pas ici, mais si on en avait on aurait fait ceci : 
```{r}
#sum(duplicated(cpf))
```

## Question 2

Creation de la nouvelle variable **'nb_dossier'** : opération sur 2 colonnes
```{r}
total_cout=cpf$nb_dossiers*cpf$prix_moyen
```

Ajout d'une colonne **'cout_total'** dans la table avec la variable **'total_cout'**
```{r}
cpf$cout_total = total_cout

head(cpf)
```


Comparaison entre 2 colonnes et création d'une colonne **'match_montant_enagage'**
```{r}
verif=cpf$montant_engage==cpf$cout_total

cpf$match_montant_enagage=verif
```

Calculer les fréquences de TRUE et FALSE
```{r}
cpf_comp <- cpf %>%
  count(match_montant_enagage) %>%
  mutate(pourcentage = n / sum(n) * 100) %>%
  rename(nombre=n)

head(cpf_comp)
```

## Queston 3

Changement du texte d'une occurrence :"Yoga" par "Cours de yoga" dans une colonne ciblée : **'libelle_formacode_principal'**
```{r}
cpf$libelle_formacode_principal <- gsub("Yoga", "Cours de yoga", cpf$libelle_formacode_principal)

head(cpf)
```

## Question 4 
Table **'dep_money'** avec la somme cumulée de **'montant_engage'** pour tous les départements
```{r}
dep_money <- cpf %>%
  group_by(departement_lieu_formation) %>% 
  summarize(somme_montant_engage = sum(montant_engage, 
                                       na.rm = TRUE)) %>% 
  mutate(somme_cumulee = cumsum(somme_montant_engage)) %>% 
  ungroup() %>%
  as.data.frame()
```


Filtrer pour garder le departement :"Paris"
```{r}
dep_money %>% 
  filter(departement_lieu_formation == "Paris") %>%
  select(somme_montant_engage,somme_cumulee) 
  
head(dep_money)
```

## Question 5

Filtrage pour l'année 2022, grouper par région et calculer le nombre de sessions et le montant total : création du dataframe **'train_ref'**
```{r}
#filtrage + groupage et somme 
train_reg <- cpf %>%
  filter(année.de.validation == 2022) %>%  
  group_by(region_lieu_formation) %>%
  summarise(
    nombre_sessions = n(),
    montant_total = sum(prix_moyen, na.rm = TRUE))  %>%
  as.data.frame()

head(train_reg)
```


## Question 6

Jeu de donnée avec la taille de la population de la région (au 1er janvier 2023)
```{r}
pop_region=read.csv("../data/external/fr_population.region.departement.csv",sep=";")
```

Renommage de la colonne pour homogénéïté
```{r}
pop_region <- pop_region %>%
  rename(region_lieu_formation = "Evolution.de.la.population.par.région")

head(pop_region)
```


Fusion des deux jeux de données (**'train_reg'** et **'pop_region'**) en **'pop_formations_reg'**
```{r}
pop_formations_reg <- left_join(train_reg, pop_region,by = "region_lieu_formation") 
names(pop_formations_reg)[7]="population2024"

head(pop_formations_reg)

```

Supression des colonnes inutiles
```{r}
pop_formations_reg <- pop_formations_reg %>% 
  select(-Recensement.1990, -Recensement.1999,-X1er.janvier.2008)

head(pop_formations_reg)

```

Type de fusion : left_join pour conserver toutes les régions du jeu de données principal (train_reg) tout en ajoutant les données de population pour celles qui existent également dans data_population. Les régions sans correspondance auront des valeurs manquantes (NA) dans les colonnes issues de data_population.

Régions conservées et perdues : Les régions présentes dans les deux jeux de données seront conservées avec leurs données fusionnées. Les régions qui sont dans train_reg mais pas dans data_population seront conservées, mais avec des valeurs manquantes pour la population.

Fusion et création du jeu de données intermédiaire : Après la fusion, vous avez nettoyé la colonne de population, l'avez convertie en entier, puis calculé le montant d'argent dépensé par habitant en divisant le montant total par la population de chaque région.

Nettoyage des valeurs non numériques en supprimant les espaces et les caractères non numériques dans population2024
```{r}
pop_formations_reg$population2024 <- gsub("[^0-9]", "", pop_formations_reg$population2024)
#char=substr(pop_formations_reg$population2024[1],2,2)
```

Conversion les chaînes nettoyées en numérique puis en entier
```{r}
# numériques (NA seront conservés)
pop_formations_reg$population2024 <- as.numeric(pop_formations_reg$population2024)

#on convertie en integer
pop_formations_reg$population2024 <- as.integer(pop_formations_reg$population2024) 
```


```{r}
# Calcul montant_par_habitant en préservant les NA
pop_formations_reg <- pop_formations_reg %>%
  mutate(montant_par_habitant = montant_total / population2024)

# Afficher la nouvelle colonne montant_par_habitant
pop_formations_reg$montant_par_habitant

head(pop_formations_reg)
```


```{r}
colnames(pop_formations_reg)
```

## Question 7 

Filtrage des lignes où status_dossier contient "Clos"
```{r}
cpf <- cpf %>%
  filter(str_detect(statut_dossier,"Clos"))

head(cpf)
```

Pourquoi est-ce utile de filtrer les dossiers où le statut n'est pas "Clos" ?
Lorsqu'on calcule un taux de réalisation, on veut généralement évaluer la proportion des dossiers qui ont été complètement traités, ce qui implique qu'ils ont le statut "Clos". Garder uniquement les dossiers "Clos" permet d'exclure ceux qui sont encore en cours ou dans un autre état, ce qui garantirait que le taux de réalisation reflète correctement uniquement les dossiers finalisés.

## Question 8 

Calculer la **'Réalisation totale'** par département
```{r}
# filtrage statut "Réalisation totale" ou "Réalisation partielle"
real_tot_dep <- cpf %>%
  filter(statut_dossier_modif == "Réalisation totale") %>%
  group_by(departement_lieu_formation) %>%
  summarise(total_dossiers = n(),  
            total_realisation = sum(montant_engage, na.rm = TRUE)
  ) %>%
  mutate(pourcentage_realisation = total_realisation / total_dossiers * 100)  
         

head(real_tot_dep)
```


Pourquoi se concentrer sur les dossiers clos ? Calculer un taux de "Réalisation totale" est pertinent sur les dossiers qui sont déjà clos, car ce sont ceux qui ont été entièrement traités et finalisés. En excluant les dossiers non clos (en cours ou en attente), vous vous concentrez uniquement sur ceux qui sont achevés. Cela permet de mesurer le taux d'accomplissement des dossiers terminés dans chaque département.

Réalisation par département :
L’analyse par département permet d’évaluer la performance de chaque département en termes de traitement et de finalisation des dossiers. En calculant le pourcentage de réalisation par rapport au nombre total de dossiers clos, vous avez une vue d'ensemble de l'efficacité de chaque département.

Fusion avec pop_formations_reg pour ajouter des informations supplémentaires
```{r}
real_dep_full <- left_join(real_tot_dep, pop_formations_reg, by = "departement_lieu_formation")

head(real_dep_full)