---
title: "Identifier des données manquantes"
output: html_notebook
---

```{r}
library(VIM)
library(dplyr)
library(naniar)
library(ggplot2)
library(tidyr)
library(reshape2)
library(visdat)
library(ggcorrplot)
library(corrplot)
library(corrplot)
library(dplyr)
```

## Importation du data set phd 

```{r}
phd=read.csv("../data/PhD.dataset.csv")
head(phd)
summary(phd)
```

Nom des colonnes du data set **'phd'** 
```{r}
names(phd)
```

Amélioration des données
```{r}
phd <- phd[,-1] #on supprime X qui ne sert à rien
```



Extraire les valeurs prises par une colonne manuellement
```{r}
valeurs_uniques <- unique(phd$Langue.de.la.these[!is.na(phd$Langue.de.la.these)]) 
head(valeurs_uniques)
```

Nettoyage des données avec NA
```{r}
#remplacer les valeurs parasites par du NA
phd[phd == "" | phd == " " | #vide ou espace
       phd=="na" | #pas detecté par R en tant que NA (Langue.de.la.these,Identifiant.directeur...)
       phd=="#NAME?" | # (Auteur,Titre)
       phd=="unknown" | phd == "andy" | # (Genre) par contre si unknown c'est pas une erreur (non binaire, genderfluid ect) on laisse
       phd=="Directeur de these inconnu" #  (Directeur.de.these)
     ] <- NA #remplacer l'absence de valeur ou les erreurs par NA


head(phd)
```


```{r}
# Nombre total de valeurs manquantes
total_na <- sum(is.na(phd))
total_na
```

Nombre total de données 
```{r}
total_data <- count(phd) * ncol(phd)
total_data
```

Pourcentage de donnée manquante
```{r}
pourcentage_na <- total_na / total_data
pourcentage_na
```


Valeurs manquantes par colonne
```{r}
na_par_colonne <- colSums(is.na(phd))

na_phd <- data.frame(variable = names(na_par_colonne), 
                    na_par_colonne = na_par_colonne,row.names = NULL)
head(na_phd)
```


```{r}
na_phd$pourcentage_donnee_manquante = round((na_phd$na_par_colonne/nrow(phd))*100)

head(na_phd)

#colnames(na_phd)
```


```{r}
ggcor(phd)
```




```{r}
# Sélectionner les colonnes spécifiques pour la corrélation comme dans le pdf 
phd_cor <- phd %>%
  select(Identifiant.auteur, Titre, Directeur.de.these..nom.prenom., Directeur.de.these,
         Etablissement.de.soutenance, Identifiant.etablissement, Date.de.premiere.inscription.en.doctorat,
         Date.de.soutenance, Mise.a.jour.dans.theses.fr, Year, etablissement_rec, Langue_rec)
```


```{r}
# Modifier les noms des colonnes pour qu'ils soient plus lisibles
names(phd_cor) <- gsub("Directeur.de.these", "Directeur de thèse", names(phd_cor))
names(phd_cor) <- gsub("Identifiant.auteur", "Identifiant de l'auteur", names(phd_cor))
names(phd_cor) <- gsub("Titre", "Titre de la thèse", names(phd_cor))
names(phd_cor) <- gsub("Directeur.de.these..nom.prenom.", "Directeur de thèse (Nom, Prénom)", names(phd_cor))
names(phd_cor) <- gsub("Etablissement.de.soutenance", "Établissement de soutenance", names(phd_cor))
names(phd_cor) <- gsub("Identifiant.etablissement", "Identifiant de l'établissement", names(phd_cor))
names(phd_cor) <- gsub("Date.de.premiere.inscription.en.doctorat", "Date de première inscription en doctorat", names(phd_cor))
names(phd_cor) <- gsub("Date.de.soutenance", "Date de soutenance", names(phd_cor))
names(phd_cor) <- gsub("Mise.a.jour.dans.theses.fr", "Mise à jour dans theses.fr", names(phd_cor))
names(phd_cor) <- gsub("Year", "Année", names(phd_cor))
names(phd_cor) <- gsub("etablissement_rec", "Établissement ", names(phd_cor))
names(phd_cor) <- gsub("Langue_rec", "Langue", names(phd_cor))
```


```{r}
# Calculer la matrice de corrélation des valeurs manquantes (1 pour manquant, 0 pour non manquant)
missing_matrix <- is.na(phd_cor)
cor_matrix <- cor(missing_matrix, use = "pairwise.complete.obs")

# Masquer la diagonale et les éléments du triangle supérieur
cor_matrix[upper.tri(cor_matrix, diag = TRUE)] <- NA

# Transformer la matrice pour ggplot2
cor_melt <- melt(cor_matrix, na.rm = TRUE)
```


```{r}
# Visualiser la matrice de corrélation avec les couleurs demandées, sans afficher les zéros et avec le triangle inférieur uniquement
ggplot(cor_melt, aes(x = Var1, y = Var2, fill = value)) +
  geom_tile(color = "white") +
  # Afficher les valeurs uniquement si elles sont différentes de zéro et non nulles
  geom_text(aes(label = ifelse(!is.na(value) & abs(value) > 0.01, round(value, 1), "")), color = "black", size = 3) +
  scale_fill_gradient2(low = "#8A0D1E", high = "#003C57", mid = "#F0F0F0", 
                       midpoint = 0, limit = c(-1, 1), space = "Lab", name="Corrélation") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1),
        axis.text.y = element_text(hjust = 1)) +
  labs(title = "Corrélation entre les différentes variables concernant l'absence de données",
       x = "", y = "") +
  coord_fixed(ratio = 1, clip = "off")
```




```{r}
# Calculer la matrice de corrélation des données manquantes
missing_matrix <- is.na(phd) %>% as.matrix() %>% as.data.frame()
cor_matrix <- cor(missing_matrix, use = "pairwise.complete.obs")
```


```{r}
# Afficher la matrice de corrélation avec triangle inférieur, labels en bas et à gauche, et échelle de couleur à droite
corrplot(
  cor_matrix,
  method = "color",
  type = "lower",        # Triangle inférieur uniquement
  tl.col = "black",
  tl.cex = 0.6,          # Taille du texte des labels
  #tl.srt = 0,            # Labels horizontaux en bas et à gauche
  addCoef.col = "black", # Affiche les valeurs numériques
  number.cex = 0.2,      # Réduit la taille des valeurs affichées
  na.label = " ",        # Masque les valeurs nulles
  cl.pos = "r",          # Positionne l'échelle de couleur à droite
  cl.ratio = 0.2,        # Ajuste la taille de l'échelle de couleur
  mar = c(2, 2, 1, 1),   # Ajuste les marges pour éviter la superposition des données
  diag = FALSE,          # Retire les labels de la diagonale
  title = "Corrélation des données manquantes"
)
```

## Headmap donnée manquante

```{r}
# Filtrer les colonnes nécessaires
missing_data  <- phd %>% 
  select(Statut, Identifiant.auteur, Date.de.premiere.inscription.en.doctorat, Date.de.soutenance) %>%
  pivot_longer(cols = -Statut, names_to = "Variable", values_to = "Valeur") %>%
  group_by(Statut, Variable) %>%
  summarize(pct_missing = mean(is.na(Valeur)) * 100) %>%
  ungroup()
```


```{r}
# Créer la heatmap avec ggplot2
ggplot(missing_data, aes(x = Statut, y = Variable, fill = pct_missing)) +
  geom_tile(color = "white") +
  scale_fill_gradient(low = "#FFEB69", high = "#A7001E", na.value = "white") +
  geom_text(aes(label = round(pct_missing, 1)), color = "black", size = 4) +
  labs(title = "Visualisation de patterns dans les données manquantes",
       x = "Statut", 
       y = "Variables", 
       fill = "Pourcentage") +
  theme_minimal()
```


## Nom du graphe 

```{r}
#ooccurrences de données manquantes
gg_miss_upset(phd) 
```


```{r}
gg_miss_var(phd) +
  labs(title = "Quantité de valeurs manquantes par variable",
       x = "Variables",
       y = "Nombre de valeurs manquantes")
```


A supp je pense.

```{r}
ggplot(phd, aes(x = reorder(variable, -pourcentage_donnee_manquante), y = pourcentage_donnee_manquante, fill = pourcentage_donnee_manquante > 0)) +
  geom_bar(stat = "identity") +
  coord_flip() +  # Pour une meilleure lisibilité
  labs(title = "Pourcentage de valeurs manquantes par variable",
       x = "Variables",
       y = "Pourcentage de NA") +
  theme_minimal() +
  scale_fill_manual(values = c("red", "green"), 
                    labels = c("Présent", "Manquant"), 
                    name = "Statut")
```
6.2 : Détection d’un problème dans les données

```{r}
# Si les dates sont dans le format jour-mois-année avec une année à 2 chiffres (par exemple, 24-11-08)
data$Date.de.soutenance <- as.Date(data$Date.de.soutenance, format = "%d-%m-%y")  # Utilisation de l'année à 2 chiffres

# Convertir les années à 2 chiffres en années à 4 chiffres
data$Date.de.soutenance <- format(data$Date.de.soutenance, "%d-%m-%Y")

# Vérifier les premières lignes après correction
head(data$Date.de.soutenance)
```


```{r}
#chgm dans de classe Date
Date.de.soutenance <- as.Date(data$Date.de.soutenance, format= "%d-%m-%y")

#creation d'une variable avec les mois des soutenances
Mois.de.soutenance <- format(Date.de.soutenance, "%B") #pour avoir le nom des mois

# Compter les occurrences de chaque mois
mois_counts_var <- table(Mois.de.soutenance)

mois_counts <- data.frame(Mois = names(mois_counts_var), Frequence = as.integer(mois_counts)) 

head(mois_counts)

```


```{r}
# Conversion de la colonne Date.de.soutenance en format Date
Date.de.soutenance <- as.Date(data$Date.de.soutenance, format = "%d-%m-%Y")  # Pour année à 4 chiffres



# Création d'une variable avec les noms des mois des soutenances
Mois.de.soutenance <- format(Date.de.soutenance, "%B")  # "%B" donne les noms complets des mois

# Compter les occurrences de chaque mois
mois_counts <- table(Mois.de.soutenance)

# Transformer en data.frame pour affichage plus lisible
df_mois_counts <- data.frame(Mois = names(mois_counts), Frequence = as.integer(mois_counts))

# Afficher le data frame
print(df_mois_counts)
```


```{r}
Year.extrait <- data$Year

Year.extrait <- Year.extrait[Year.extrait>=1985] #effet de bord

#Anne_count <- data.frame(Year.extrait)

Anne_count <- data.frame(Year.extrait) %>%
  count(Year.extrait)

Anne_count <- Anne_count %>% rename(Nombre = n,Année=Year.extrait)

Anne_count
```


```{r}
data$Date.de.soutenance <- as.Date(data$Date.de.soutenance, format = "%d-%m-%y")

data_extraite_janvier <- data %>% 
  filter(format(Date.de.soutenance, "%d-%m") == "01-01",Year>=1985)  # filtrer pour le 1er janvier et après 1985
  
head(data_extraite_janvier)
```


```{r}
total_theses_par_annee <- data %>%
  group_by(Year) %>%
  summarise(Total = n(), .groups = 'drop')

theses_janvier <- data_extraite_janvier %>%
  group_by(Year) %>%
  summarise(Janvier_Count = n(), .groups = 'drop')

proportion_theses <- theses_janvier %>% # Étape 5 : Joindre les deux dataframes pour calculer la proportion
  left_join(total_theses_par_annee, by = "Year") %>%
  mutate(Proportion = Janvier_Count / Total * 100)  # Calculer la proportion en pourcentage

ggplot(proportion_theses, aes(x = Year, y = Proportion)) +
  geom_line(color = "blue", size = 1) +  # Tracer la courbe
  labs(title = "Proportion des thèses soutenues le 1er janvier depuis 1985",
       x = "Année",
       y = "Proportion (%)") +
  theme(panel.border = element_rect(color = "black", fill = NA, size = 1),  # Ajouter un cadre autour du graphique
    plot.background = element_rect(fill = "white"))  # Remplir l'arrière-plan) +
  ylim(0, max(proportion_theses$Proportion, na.rm = TRUE) * 1.1)  # Ymax adaptatif
```





```{r}
#graphique en supprimant la phase d'apparition de la bdd (avant 1985)
#date ymax addaptatif
#diviser par le nombre de thèse soutenue par année

```


```{r}
#"cecile martin", homonyme
```


```{r}

data_filtered <- data %>%
  filter(Year >= 1985) #on commence à 1985 car avant pas bcp de donnée

data_summary <- data_filtered %>%
  group_by(Year, Langue_rec) %>%
  summarise(Nombre = n()) %>%
  ungroup()


ggplot(data_summary, aes(x = Year, y = Nombre, fill = Langue_rec)) +
  geom_area(position = "stack") +  # Position empilée
  labs(title = "Évolution du choix de langue au fil du temps",
       x = "Année",
       y = "Nombre de thèses",
       fill = "Langue") +
  scale_fill_manual(values = c("#A9CEF4", "#000000","#36494E", "#7EA0B7", "#597081"))

```




