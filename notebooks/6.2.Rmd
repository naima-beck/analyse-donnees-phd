---
title: "Détection d’un problème dans les données"
output: html_notebook
---

```{r}
# Chargement des librairies nécessaires
library(dplyr)
library(ggplot2)
library(lubridate)
```

Importation et amélioration du dataset
```{r}
phd=read.csv("../data/PhD.dataset.csv")
phd <- phd[,-1] #on supprime X qui ne sert à rien
```

Ajout de NA
```{r}
#remplacer les valeurs parasites par du NA
phd[phd == "" | phd == " " | #vide ou espace
       phd=="na" | #pas detecté par R en tant que NA (Langue.de.la.these,Identifiant.directeur...)
       phd=="#NAME?" | # (Auteur,Titre)
       phd=="unknown" | phd == "andy" | # (Genre) par contre si unknown c'est pas une erreur (non binaire, genderfluid ect) on laisse
       phd=="Directeur de these inconnu" | #  (Directeur.de.these)
       phd=="<NA>" # (Date.de.soutenance)
     ] <- NA #remplacer l'absence de valeur ou les erreurs par NA
```
 
Colonne **`Date.de.soutenance`**  au format date
```{r}
# les dates sont dans le format jour-mois-année avec une année à 2 chiffres
phd$Date.de.soutenance <- as.Date(phd$Date.de.soutenance, format = "%d-%m-%y")  # Utilisation de l'année à 2 chiffres
head(phd$Date.de.soutenance)
```


```{r}
# Tableau de correspondance pour les mois en français
mois_fr <- c("janvier", "février", "mars", "avril", "mai", "juin", 
             "juillet", "août", "septembre", "octobre", "novembre", "décembre")
```

Data frame avec la colonne **`Date.de.soutenance`** + une colonne annee, mois en chiffre et en lettre
Filtrer les dates et conserver uniquement les colonnes souhaitées
```{r}

 date_soutenance <- phd %>%
  filter(year(Date.de.soutenance)>=1985) %>% ##pas bcp de données avant 1985
  mutate(
    annee = year(Date.de.soutenance),
    mois_chiffre = month(Date.de.soutenance),
    mois = factor(mois_fr[month(Date.de.soutenance)], levels = mois_fr),  # Mois en lettres françaises
    jour = day(Date.de.soutenance)
  ) %>%
  select(Date.de.soutenance, annee, mois,mois_chiffre,jour)  # Garder seulement les colonnes souhaitées

head(date_soutenance)
```

# Visualisation du problème de la sureprésentaion du 1e janvier


Filtrer les thèses soutenues le 1er janvier et comptage
```{r}
these_1j <- date_soutenance %>%
  filter(jour == 1 & mois_chiffre == 1) %>% # Filtrer uniquement le 1er janvier
  group_by(annee) %>%
  summarise(janvier_count = n(), .groups = 'drop')  # Nombre de thèses soutenues le 1er janvier

head(these_1j)
```

Comptage des thèses soutenues chaque année
```{r}
these_annee <- date_soutenance %>%
  group_by(annee) %>%
  summarise(total_theses = n(), .groups = 'drop')  # Nombre total de thèses par année

head(these_annee)
```

Fusion des deux dataframes pour obtenir la proportion
```{r}
these_prop_1j <- these_annee %>%
  left_join(these_1j, by = "annee") %>%
  mutate(proportion_janvier = (janvier_count / total_theses) * 100)  # Calculer la proportion en %

head(these_prop_1j)

```
```{r}
# Créer la courbe de la proportion des thèses soutenues le 1er janvier avec un cadre
ggplot(these_prop_1j, aes(x = annee, y = proportion_janvier)) +
  geom_line(color = "#EBACA2", size = 1) +  # Ajouter une ligne pour la proportion
  scale_x_continuous(
    breaks = seq(min(these_prop_1j$annee, na.rm = TRUE), 
                 max(these_prop_1j$annee, na.rm = TRUE), 
                 by = 10)  # Espacement des graduations tous les 10 ans
  ) + 
  labs(title = "Proportion des thèses soutenues au premier janvier de 1985 à 2018",
       x = "Année", 
       y = "Proportion des thèses soutenues (%)") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),  # Rotation des labels pour lisibilité
    panel.border = element_rect(colour = "black", fill = NA, size = 1)  # Ajouter un cadre autour du graphique
  )
```

Garder les année de 2005 à 2008
```{r}
these_prop_1j_2005_2018 <- these_prop_1j %>%
  #filter(year(Date.de.soutenance) >= 2005 & year(Date.de.soutenance) <= 2018)
  filter (annee>= 2005 & annee <= 2018 ) 

head(these_prop_1j_2005_2018)
```

```{r}
# Créer la courbe de la proportion des thèses soutenues le 1er janvier
ggplot(these_prop_1j_2005_2018, aes(x = annee, y = proportion_janvier)) +
  geom_line(color = "#CA3C66", size = 1) +  # Ajouter une ligne pour la proportion
  scale_x_continuous(breaks = seq(2005, 2018, by = 1)) +  # Fixer les années en abscisse
  labs(title = "Proportion des thèses soutenues au premier janvier de 2005 à 2018",
       x = "Année", 
       y = "Proportion des thèses soutenues (%)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  # Rotation des labels pour lisibilité
```






```{r}
date_soutenance_2005_2018 <- date_soutenance %>%
  filter (annee>= 2005 & annee <= 2018 ) 

head(date_soutenance_2005_2018)

date_soutenance_2005_2018_count <- date_soutenance_2005_2018 %>% 
  group_by(annee, mois, mois_chiffre) %>%  # Grouper par année, mois et mois_chiffre
  summarise(count = n(), .groups = 'drop')  # Compter le nombre d'occurrences
head(date_soutenance_2005_2018_count)

```

Bar plot pour chaque année avec le nombre d'occurence par mois
```{r}
ggplot(date_soutenance_2005_2018_count, aes(x = mois, y = count, fill = mois)) +
  geom_bar(stat = "identity") +  # Utilisation de "stat = identity" pour la hauteur des barres
  facet_wrap(~ annee, scales = "free_y", ncol = 4) +  # Utilisation de 4 colonnes pour mieux répartir les graphiques
  labs(title = "Distribution des occurrences par mois et par année", 
       x = "Mois", y = "Nombre d'occurrences") +
  theme_minimal() +  # Utiliser un thème minimal
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 8),  # Réduction de la taille du texte
    strip.text = element_text(size = 10)  # Ajuster la taille du texte pour les titres des facettes
  ) +
  scale_x_discrete(labels = mois_fr)  # Mettre les mois en français sur l'axe X
```

```{r}
# Calculer l'erreur type
data_filtree3 <- date_soutenance %>%
  arrange(annee) %>% 
  group_by(annee, mois_chiffre) %>%
  summarise(
    count = n(),  # Nombre d'occurrences
    mean_count = mean(count),  # Moyenne des occurrences
    sd_count = sd(count),  # Ecart-type des occurrences
    se_count = sd_count / sqrt(n()),  # Erreur type
    .groups = 'drop'
  )

# Créer un bar plot pour chaque année avec les occurrences par mois et l'erreur type
ggplot(data_filtree3, aes(x = mois_chiffre, y = mean_count, fill = factor(annee))) +
  geom_bar(stat = "identity", position = "dodge") +  # Barres pour la moyenne des occurrences
  geom_errorbar(aes(ymin = mean_count - se_count, ymax = mean_count + se_count), 
                width = 0.2, position = position_dodge(width = 0.9)) +  # Ajouter les barres d'erreur
  scale_x_continuous(breaks = 1:12, labels = month.name) +  # Mettre les mois sur l'axe des X
  labs(title = "Occurrences par mois pour chaque année avec erreur type",
       x = "Mois", 
       y = "Nombre d'occurrences",
       fill = "Année") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) 
```

Occurrences par mois pour chaque année 
```{r}
#graphique pour chaque année avec les occurrences par mois
ggplot(date_soutenance_2005_2018_count, aes(x = mois_chiffre, y = count, group = annee, color = factor(annee))) +
  geom_line() +  # Créer une ligne
  geom_point() + # Ajouter des points
  scale_x_continuous(breaks = 1:12, labels = month.name) +  # Mettre les mois sur l'axe des X
  labs(title = "Occurrences par mois pour chaque année de 2005 à 2018",
       x = "Mois", 
       y = "Nombre d'occurrences",
       color = "Année") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) 

```

Moyenne des occurrences par mois avec erreur-type
```{r}

# Calculer la moyenne et l'erreur-type globales pour chaque mois
date_soutenance_2005_2018_erreur <- date_soutenance_2005_2018_count %>%
  group_by(mois_chiffre) %>%
  summarise(
    mean_count = mean(count),  # Moyenne des occurrences pour chaque mois
    sd_count = sd(count),      # Ecart-type des occurrences pour chaque mois
    se_count = sd_count / sqrt(n()),  # Erreur type pour chaque mois
    .groups = 'drop'
  )

# Créer un bar plot avec la moyenne des occurrences et l'erreur type
ggplot(date_soutenance_2005_2018_erreur, aes(x = mois_chiffre, y = mean_count)) +
  geom_bar(stat = "identity", fill = "#A7001E", width = 0.7) +  # Barres pour la moyenne des occurrences
  geom_errorbar(aes(ymin = mean_count - se_count, ymax = mean_count + se_count), 
                width = 0.2) +  # Ajouter les barres d'erreur
  scale_x_continuous(breaks = 1:12, labels = mois_fr) +  # Afficher les mois en français
  labs(title = "Moyenne des occurrences par mois avec erreur-type de 2005 à 2018",
       x = "Mois", 
       y = "Moyenne des occurrences") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  # Rotation des lab
```
Proportion des thèses soutenues au fil des mois
```{r}
# Calculer le total des thèses pour chaque année dans un nouveau dataframe
date_soutenance_2005_2018_prct <- date_soutenance_2005_2018_count %>%
  group_by(annee) %>%
  mutate(total_annee = sum(count)) %>% 
  mutate(pourcentage = (count / total_annee) * 100) %>%  # Calculer le pourcentage pour chaque mois
# Total des thèses pour chaque année %>%
  group_by(mois_chiffre) %>%
  summarise(
    mean_percentage = mean(pourcentage),  # Moyenne du pourcentage de thèses pour chaque mois
    sd_percentage = sd(pourcentage),      # Ecart-type du pourcentage de thèses pour chaque mois
    se_percentage = sd_percentage / sqrt(n()),  # Erreur type pour chaque mois
    .groups = 'drop'
  ) %>%
  ungroup()  # Retirer le groupement

head(date_soutenance_2005_2018_prct)
```

```{r}
# Créer un bar plot avec le pourcentage de thèses défendues et l'erreur-type
ggplot(date_soutenance_2005_2018_prct, aes(x = mois_chiffre, y = mean_percentage)) +
  geom_bar(stat = "identity", fill = "#7AA95C", width = 0.7) +  # Barres pour la moyenne des pourcentages
  geom_errorbar(aes(ymin = mean_percentage - se_percentage, ymax = mean_percentage + se_percentage), 
                width = 0.2) +  # Ajouter les barres d'erreur
  scale_x_continuous(breaks = 1:12, labels = mois_fr) +  # Afficher les mois en français
  labs(title = "Proportion des thèses soutenues au fil des mois de 2005 à 2018",
       x = "Mois", 
       y = "Pourcentage de thèses défendues durant l'année (%)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  # Rotation des labels pour lisibilité
```

# Visualisation des données sans le 1er janvier 

```{r}
date_stn_2005_2018_ss_1j <- date_soutenance_2005_2018 %>%
  filter (!(mois_chiffre==1 & jour==1) )

head(date_stn_2005_2018_ss_1j)

date_stn_2005_2018_ss_1j_count <- date_stn_2005_2018_ss_1j %>% 
  group_by(annee, mois, mois_chiffre) %>%  # Grouper par année, mois et mois_chiffre
  summarise(count = n(), .groups = 'drop')  # Compter le nombre d'occurrences
head(date_stn_2005_2018_ss_1j_count)
```
Bar plot pour chaque année avec le nombre d'occurence par mois
```{r}
ggplot(date_stn_2005_2018_ss_1j_count, aes(x = mois, y = count, fill = mois)) +
  geom_bar(stat = "identity") +  # Utilisation de "stat = identity" pour la hauteur des barres
  facet_wrap(~ annee, scales = "free_y", ncol = 4) +  # Utilisation de 4 colonnes pour mieux répartir les graphiques
  labs(title = "Distribution des occurrences par mois et par année", 
       x = "Mois", y = "Nombre d'occurrences") +
  theme_minimal() +  # Utiliser un thème minimal
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 8),  # Réduction de la taille du texte
    strip.text = element_text(size = 10)  # Ajuster la taille du texte pour les titres des facettes
  ) +
  scale_x_discrete(labels = mois_fr)  # Mettre les mois en français sur l'axe X
```


Occurrences par mois pour chaque année 
```{r}
#graphique pour chaque année avec les occurrences par mois
ggplot(date_stn_2005_2018_ss_1j_count, aes(x = mois_chiffre, y = count, group = annee, color = factor(annee))) +
  geom_line() +  # Créer une ligne
  geom_point() + # Ajouter des points
  scale_x_continuous(breaks = 1:12, labels = month.name) +  # Mettre les mois sur l'axe des X
  labs(title = "Occurrences par mois pour chaque année de 2005 à 2018",
       x = "Mois", 
       y = "Nombre d'occurrences",
       color = "Année") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) 

```
Moyenne des occurrences par mois avec erreur-type
```{r}
# Calculer la moyenne et l'erreur-type globales pour chaque mois
date_soutenance_2005_2018_ss_1j_erreur <- date_stn_2005_2018_ss_1j_count %>%
  group_by(mois_chiffre) %>%
  summarise(
    mean_count = mean(count),  # Moyenne des occurrences pour chaque mois
    sd_count = sd(count),      # Ecart-type des occurrences pour chaque mois
    se_count = sd_count / sqrt(n()),  # Erreur type pour chaque mois
    .groups = 'drop'
  )

# Créer un bar plot avec la moyenne des occurrences et l'erreur type
ggplot(date_soutenance_2005_2018_ss_1j_erreur, aes(x = mois_chiffre, y = mean_count)) +
  geom_bar(stat = "identity", fill = "#A7001E", width = 0.7) +  # Barres pour la moyenne des occurrences
  geom_errorbar(aes(ymin = mean_count - se_count, ymax = mean_count + se_count), 
                width = 0.2) +  # Ajouter les barres d'erreur
  scale_x_continuous(breaks = 1:12, labels = mois_fr) +  # Afficher les mois en français
  labs(title = "Moyenne des occurrences par mois avec erreur-type de 2005 à 2018",
       x = "Mois", 
       y = "Moyenne des occurrences") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  # Rotation des lab
```


Proportion des thèses soutenues au fil des mois de 2005 à 2018
```{r}
# Calculer le total des thèses pour chaque année dans un nouveau dataframe
date_soutenance_2005_2018_ss_1j_prct <- date_stn_2005_2018_ss_1j_count %>%
  group_by(annee) %>%
  mutate(total_annee = sum(count)) %>% 
  mutate(pourcentage = (count / total_annee) * 100) %>%  # Calculer le pourcentage pour chaque mois
# Total des thèses pour chaque année %>%
  group_by(mois_chiffre) %>%
  summarise(
    mean_percentage = mean(pourcentage),  # Moyenne du pourcentage de thèses pour chaque mois
    sd_percentage = sd(pourcentage),      # Ecart-type du pourcentage de thèses pour chaque mois
    se_percentage = sd_percentage / sqrt(n()),  # Erreur type pour chaque mois
    .groups = 'drop'
  ) %>%
  ungroup()  # Retirer le groupement

head(date_soutenance_2005_2018_ss_1j_prct)
```

Proportion des thèses soutenues au fil des mois si on retire le premier janvier
```{r}
# Créer un bar plot avec le pourcentage de thèses défendues et l'erreur-type
ggplot(date_soutenance_2005_2018_ss_1j_prct, aes(x = mois_chiffre, y = mean_percentage)) +
  geom_bar(stat = "identity", fill = "#7AA95C", width = 0.7) +  # Barres pour la moyenne des pourcentages
  geom_errorbar(aes(ymin = mean_percentage - se_percentage, ymax = mean_percentage + se_percentage), 
                width = 0.2) +  # Ajouter les barres d'erreur
  scale_x_continuous(breaks = 1:12, labels = mois_fr) +  # Afficher les mois en français
  labs(title = "Proportion des thèses soutenues au fil des mois de 2005 à 2018",
       x = "Mois", 
       y = "Pourcentage de thèses défendues durant l'année (%)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  # Rotation des labels pour lisibilité
```


# Visualisation des soutenances au cours du mois de décembre de 2005 à 2008


```{r}
head(date_soutenance_2005_2018)
```

```{r}
decembre_2005_2018 <- date_soutenance_2005_2018 %>%
  filter(mois_chiffre==12) %>%
  group_by(jour) %>%
  summarise(count = n(), .groups = 'drop')
  
head(decembre_2005_2018)
```
Le nombre de soutenances par jour en décembre de 2005 à 2018
```{r}
ggplot(decembre_2005_2018, aes(x = factor(jour), y = count)) +
  geom_bar(stat = "identity", fill = "#FF9CB6", width = 0.7) +  # Barres pour le nombre de soutenances
  labs(title = "Nombre de soutenances par jour le nombre de soutenances par jour de 2005 à 2018", 
       x = "Jour du mois", 
       y = "Nombre de soutenances") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  # Rotation des labels pour lisibilité
```

# Homonyme : Cecile Martin, Michel Mace

Extraction des noms d'auteur avec le nombre de thèses
```{r}
phd_homonyme <- phd %>%
  group_by(Auteur) %>% 
  summarise(nombre_theses = n(), .groups = 'drop') 

head(phd_homonyme)
```
Dataframe avec les séparations des auteurs
```{r}
phd_homonyme_sep <- phd_homonyme %>%
  separate_rows(Auteur, sep = ",") %>% # Séparer les noms par virgule
  arrange(Auteur) %>%
  filter(trimws(Auteur) != "")

head(phd_homonyme_sep)
```
Recomptage du nombre de thèses pour chaque homonyme
```{r}
# Additionner le nombre de thèses pour chaque homonyme
phd_homonyme_count <- phd_homonyme_sep %>%
  group_by(Auteur) %>%  # Grouper par homonyme
  summarise(nombre_theses = sum(nombre_theses))  # Additionner le nombre de thèses

head(phd_homonyme_count)
```

Dans l'ordre décroissant pour faire un classement des homonymes
```{r}
phd_homonyme_count <- phd_homonyme_count %>%
  arrange(desc(nombre_theses))   

head(phd_homonyme_count)
```
Comparaison entre les dataframe : Michel Mace (réussite)
